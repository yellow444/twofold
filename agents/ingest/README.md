# Agent.Ingest

Загрузчик исходных данных Росавиации: парсинг XLS/CSV/PDF/HTML, нормализация и сохранение в хранилище/БД.

## Поддерживаемые форматы

| Формат | Особенности | Ограничения |
| ------ | ----------- | ----------- |
| CSV | Потоковое чтение через Polars Scan API, авто-очистка заголовков и значений. | Файлы >200 МБ читаются в потоковом режиме; поддерживается кодировка UTF-8. |
| XLS/XLSX | Парсинг через `pandas`/`openpyxl` с приведением типов и очисткой служебных строк. | Требуется установленный `openpyxl` (для XLS — `xlrd`). |
| PDF | Попытка чтения через `camelot` → `tabula`; при недоступности библиотек выполняется текстовый парсинг таблиц с объединением страниц. | Для надёжной работы нужен структурированный табличный PDF с прямыми границами; в режиме деградации обрабатываются только строки с явными разделителями. |
| HTML | Извлечение первой таблицы через BeautifulSoup+lxml, поддержка `<meta name="report-tz">`. | Требуется корректная разметка `<table>`/`<thead>`/`<tbody>`; вложенные таблицы не поддерживаются. |

CLI-флаги:

* `python -m app.cli ingest <source>` — запуск пайплайна;
* `--format / -f` — ручной выбор формата (`csv`, `xls`, `xlsx`, `pdf`, `html`);
* `--year / -y` — проставление года партии для downstream-валидаций;
* `--storage-path / -s` — путь для выгрузки в хранилище (при отключённом `--dry-run`);
* `--dataset-version` — переопределение версии датасета в конфигурации;
* `--dry-run` — пропуск записи в хранилище, загрузка и нормализация выполняются полностью.

Ограничения и рекомендации:

* Максимальный объём входного CSV без разбиения — 1 ГБ (стриминг >200 МБ автоматически);
* В PDF желательно использовать однородные таблицы без объединённых ячеек; при ошибках парсинга агент переходит в режим текстового детектора и помечает загрузку как `metadata["degraded"]=True`;
* Для HTML требуется наличие `<table>` c первой строкой заголовков или `thead`; дополнительные таблицы игнорируются.
